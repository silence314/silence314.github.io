<!DOCTYPE html><html lang="zh-CN" data-theme="dark"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1"><title>ES常见基础问题总结 | 王鹏宇的博客</title><meta name="description" content="ES的一些基础知识和注意点，有的也是自己踩过坑的地方"><meta name="keywords" content="ES"><meta name="author" content="Wangpengyu"><meta name="copyright" content="Wangpengyu"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#0d0d0d"><meta http-equiv="Cache-Control" content="no-transform"><meta http-equiv="Cache-Control" content="no-siteapp"><link rel="shortcut icon" href="/img/favicon.png"><link rel="canonical" href="http://example.com/2023/02/12/ES%E5%B8%B8%E8%A7%81%E5%9F%BA%E7%A1%80%E9%97%AE%E9%A2%98%E6%80%BB%E7%BB%93/"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><meta name="yandex-verification" content="{&quot;theme_color&quot;:{&quot;enable&quot;:true,&quot;main&quot;:&quot;#49B1F5&quot;,&quot;paginator&quot;:&quot;#00c4b6&quot;,&quot;button_hover&quot;:&quot;#FF7242&quot;,&quot;text_selection&quot;:&quot;#00c4b6&quot;,&quot;link_color&quot;:&quot;#99a9bf&quot;,&quot;meta_color&quot;:&quot;#858585&quot;,&quot;hr_color&quot;:&quot;#A4D8FA&quot;,&quot;code_foreground&quot;:&quot;#F47466&quot;,&quot;code_background&quot;:&quot;rgba(27, 31, 35, .05)&quot;,&quot;toc_color&quot;:&quot;#00c4b6&quot;,&quot;blockquote_padding_color&quot;:&quot;#49b1f5&quot;,&quot;blockquote_background_color&quot;:&quot;#49b1f5&quot;}}"/><meta property="og:type" content="article"><meta property="og:title" content="ES常见基础问题总结"><meta property="og:url" content="http://example.com/2023/02/12/ES%E5%B8%B8%E8%A7%81%E5%9F%BA%E7%A1%80%E9%97%AE%E9%A2%98%E6%80%BB%E7%BB%93/"><meta property="og:site_name" content="王鹏宇的博客"><meta property="og:description" content="ES的一些基础知识和注意点，有的也是自己踩过坑的地方"><meta property="og:image" content="http://example.com/img/jump.png"><meta property="article:published_time" content="2023-02-12T10:43:15.000Z"><meta property="article:modified_time" content="2023-06-03T07:27:16.568Z"><meta name="twitter:card" content="summary"><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.css"><script>var GLOBAL_CONFIG = { 
  root: '/',
  hexoversion: '5.1.1',
  algolia: undefined,
  localSearch: undefined,
  translate: undefined,
  noticeOutdate: undefined,
  highlight: {"plugin":"highlighjs","highlightCopy":true,"highlightLang":true},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  bookmark: {
    message_prev: '按',
    message_next: '键将本页加入书签'
  },
  runtime: '天',
  date_suffix: {"one_hour":"刚刚","hours":"小时前","day":"天前"},
  copyright: undefined,
  ClickShowText: undefined,
  medium_zoom: false,
  fancybox: true,
  Snackbar: undefined,
  justifiedGallery: {
    js: 'https://cdn.jsdelivr.net/npm/justifiedGallery/dist/js/jquery.justifiedGallery.min.js',
    css: 'https://cdn.jsdelivr.net/npm/justifiedGallery/dist/css/justifiedGallery.min.css'
  },
  baiduPush: false,
  isPhotoFigcaption: true,
  islazyload: false,
  isanchor: false
};

var saveToLocal = {
  set: function setWithExpiry(key, value, ttl) {
    const now = new Date()
    const expiryDay = ttl * 86400000
    const item = {
      value: value,
      expiry: now.getTime() + expiryDay,
    }
    localStorage.setItem(key, JSON.stringify(item))
    },

  get: function getWithExpiry(key) {
    const itemStr = localStorage.getItem(key)

    if (!itemStr) {
      return undefined
    }
    const item = JSON.parse(itemStr)
    const now = new Date()

    if (now.getTime() > item.expiry) {
      localStorage.removeItem(key)
      return undefined
    }
    return item.value
  }
}</script><script id="config_change">var GLOBAL_CONFIG_SITE = { 
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isSidebar: true,
  postUpdate: '2023-06-03 15:27:16'
}</script><noscript><style type="text/css">
#nav {
  opacity: 1
}
.justified-gallery img {
  opacity: 1
}
</style></noscript><script>var activateDarkMode = function () {
  document.documentElement.setAttribute('data-theme', 'dark')
  if (document.querySelector('meta[name="theme-color"]') !== null) {
    document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
  }
}
var activateLightMode = function () {
  document.documentElement.setAttribute('data-theme', 'light')
  if (document.querySelector('meta[name="theme-color"]') !== null) {
    document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
  }
}

var autoChangeMode = 'false'
var t = saveToLocal.get('theme')
if (autoChangeMode === '1') {
  var isDarkMode = window.matchMedia('(prefers-color-scheme: dark)').matches
  var isLightMode = window.matchMedia('(prefers-color-scheme: light)').matches
  var isNotSpecified = window.matchMedia('(prefers-color-scheme: no-preference)').matches
  var hasNoSupport = !isDarkMode && !isLightMode && !isNotSpecified

  if (t === undefined) {
    if (isLightMode) activateLightMode()
    else if (isDarkMode) activateDarkMode()
    else if (isNotSpecified || hasNoSupport) {
      var now = new Date()
      var hour = now.getHours()
      var isNight = hour <= 6 || hour >= 18
      isNight ? activateDarkMode() : activateLightMode()
    }
    window.matchMedia('(prefers-color-scheme: dark)').addListener(function (e) {
      if (saveToLocal.get('theme') === undefined) {
        e.matches ? activateDarkMode() : activateLightMode()
      }
    })
  } else if (t === 'light') activateLightMode()
  else activateDarkMode()
} else if (autoChangeMode === '2') {
  now = new Date()
  hour = now.getHours()
  isNight = hour <= 6 || hour >= 18
  if (t === undefined) isNight ? activateDarkMode() : activateLightMode()
  else if (t === 'light') activateLightMode()
  else activateDarkMode()
} else {
  if (t === 'dark') activateDarkMode()
  else if (t === 'light') activateLightMode()
}</script><meta name="generator" content="Hexo 5.1.1"></head><body><div id="mobile-sidebar"><div id="menu_mask"></div><div id="mobile-sidebar-menus"><div class="mobile_author_icon"><img class="avatar-img" src="/null" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="mobile_post_data"><div class="mobile_data_item is-center"><div class="mobile_data_link"><a href="/archives/"><div class="headline">文章</div><div class="length_num">122</div></a></div></div><div class="mobile_data_item is-center">      <div class="mobile_data_link"><a href="/tags/"><div class="headline">标签</div><div class="length_num">53</div></a></div></div><div class="mobile_data_item is-center">     <div class="mobile_data_link"><a href="/categories/"><div class="headline">分类</div><div class="length_num">25</div></a></div></div></div><hr/><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 主页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 归档</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><i class="fa-fw fas fa-list"></i><span> 娱乐</span><i class="fas fa-chevron-down expand"></i></a><ul class="menus_item_child"><li><a class="site-page" href="/music/"><i class="fa-fw fas fa-music"></i><span> 音乐</span></a></li><li><a class="site-page" href="/movies/"><i class="fa-fw fas fa-video"></i><span> 电影</span></a></li><li><a class="site-page" href="/photos/"><i class="fa-fw fas fa-camera-retro"></i><span> 相册</span></a></li><li><a class="site-page" href="/books/"><i class="fa-fw fas fa-camera-retro"></i><span> 书籍</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> 连接</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> 关于我</span></a></div></div></div></div><div id="body-wrap"><div id="sidebar"><i class="fas fa-arrow-right on" id="toggle-sidebar"></i><div class="sidebar-toc"><div class="sidebar-toc__title">目录</div><div class="sidebar-toc__progress"><span class="progress-notice">你已经读了</span><span class="progress-num">0</span><span class="progress-percentage">%</span><div class="sidebar-toc__progress-bar">     </div></div><div class="sidebar-toc__content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#%E4%B8%80%E3%80%81ES%E7%9A%84%E7%89%B9%E7%82%B9"><span class="toc-number">1.</span> <span class="toc-text">一、ES的特点</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E4%BA%8C%E3%80%81ES%E7%9A%84%E9%80%82%E7%94%A8%E5%9C%BA%E6%99%AF"><span class="toc-number">2.</span> <span class="toc-text">二、ES的适用场景</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%85%B3%E7%B3%BB%E5%9E%8B%E6%95%B0%E6%8D%AE%E5%BA%93%E7%9A%84%E8%A1%A5%E5%85%85%E3%80%81%E4%BC%A0%E7%BB%9F%E6%95%B0%E6%8D%AE%E5%BA%93%E7%9A%84%E6%9B%BF%E4%BB%A3"><span class="toc-number">2.0.0.1.</span> <span class="toc-text">关系型数据库的补充、传统数据库的替代</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%AB%99%E5%86%85%E6%90%9C%E7%B4%A2%E3%80%81%E5%9E%82%E7%9B%B4%E6%90%9C%E7%B4%A2"><span class="toc-number">2.0.0.2.</span> <span class="toc-text">站内搜索、垂直搜索</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%AE%B0%E5%BD%95%E5%92%8C%E6%97%A5%E5%BF%97%E5%88%86%E6%9E%90"><span class="toc-number">2.0.0.3.</span> <span class="toc-text">记录和日志分析</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%85%A8%E6%96%87%E6%A3%80%E7%B4%A2"><span class="toc-number">2.0.0.4.</span> <span class="toc-text">全文检索</span></a></li></ol></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E4%B8%89%E3%80%81ES%E5%92%8CMySQL%E7%9A%84%E9%80%89%E6%8B%A9"><span class="toc-number">3.</span> <span class="toc-text">三、ES和MySQL的选择</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%9B%9B%E3%80%81ES%E8%AF%BB%E5%86%99%E5%A4%A7%E8%87%B4%E6%B5%81%E7%A8%8B%E5%92%8C%E6%9C%80%E4%BD%B3%E5%AE%9E%E8%B7%B5"><span class="toc-number">4.</span> <span class="toc-text">四、ES读写大致流程和最佳实践</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%86%99%E5%85%A5%E6%B5%81%E7%A8%8B"><span class="toc-number">4.0.1.</span> <span class="toc-text">写入流程</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%9C%80%E4%BD%B3%E5%AE%9E%E8%B7%B5"><span class="toc-number">4.0.2.</span> <span class="toc-text">最佳实践</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%9F%A5%E8%AF%A2%E6%B5%81%E7%A8%8B"><span class="toc-number">4.0.3.</span> <span class="toc-text">查询流程</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%9C%80%E4%BD%B3%E5%AE%9E%E8%B7%B5-1"><span class="toc-number">4.0.4.</span> <span class="toc-text">最佳实践</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E4%BA%94%E3%80%81%E6%88%91%E4%BB%AC%E5%B8%B8%E7%94%A8%E7%9A%84es%E6%95%B0%E6%8D%AE%E7%B1%BB%E5%9E%8B%E5%92%8C%E6%B3%A8%E6%84%8F%E4%BA%8B%E9%A1%B9"><span class="toc-number">5.</span> <span class="toc-text">五、我们常用的es数据类型和注意事项</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%95%B0%E5%AD%97%E7%B1%BB%E5%9E%8B"><span class="toc-number">5.0.0.1.</span> <span class="toc-text">数字类型</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#keyword%E7%B1%BB%E5%9E%8B"><span class="toc-number">5.0.0.2.</span> <span class="toc-text">keyword类型</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%B8%83%E5%B0%94%E7%B1%BB%E5%9E%8B-boolean"><span class="toc-number">5.0.0.3.</span> <span class="toc-text">布尔类型(boolean)</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%97%A5%E6%9C%9F%E7%B1%BB%E5%9E%8B-date"><span class="toc-number">5.0.0.4.</span> <span class="toc-text">日期类型(date)</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%95%B0%E7%BB%84%E7%B1%BB%E5%9E%8B-array"><span class="toc-number">5.0.0.5.</span> <span class="toc-text">数组类型(array)</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%B5%8C%E5%A5%97%E7%B1%BB%E5%9E%8B-nested"><span class="toc-number">5.0.0.6.</span> <span class="toc-text">嵌套类型(nested)</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%96%87%E6%9C%AC%E7%B1%BB%E5%9E%8B"><span class="toc-number">5.0.0.7.</span> <span class="toc-text">文本类型</span></a></li></ol></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%85%AD%E3%80%81ES%E4%BD%BF%E7%94%A8%E6%B3%A8%E6%84%8F%E5%AE%9E%E7%8E%B0"><span class="toc-number">6.</span> <span class="toc-text">六、ES使用注意实现</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-eagle%E5%B9%B3%E5%8F%B0%E4%BD%BF%E7%94%A8"><span class="toc-number">6.0.1.</span> <span class="toc-text">1 eagle平台使用</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#1-1-%E9%AB%98%E5%B3%B0%E6%9C%9F%E6%89%A9%E5%AE%B9"><span class="toc-number">6.0.1.1.</span> <span class="toc-text">1.1 高峰期扩容</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#1-2-%E7%BA%BF%E4%B8%8A%E6%85%8E%E7%94%A8%E2%80%9Cprofile%E2%80%9D%E5%8A%9F%E8%83%BD"><span class="toc-number">6.0.1.2.</span> <span class="toc-text">1.2 线上慎用“profile”功能</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#1-3-%E4%B8%8D%E8%A6%81%E4%BF%AE%E6%94%B9ES%E5%AD%97%E6%AE%B5%E7%9A%84%E2%80%9Cindex%E2%80%9D%E5%B1%9E%E6%80%A7"><span class="toc-number">6.0.1.3.</span> <span class="toc-text">1.3 不要修改ES字段的“index”属性</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2%E3%80%81%E6%95%85%E9%9A%9C%E5%A4%84%E7%90%86%E7%9B%B8%E5%85%B3"><span class="toc-number">6.0.2.</span> <span class="toc-text">2、故障处理相关</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#2-1-CPU%E6%89%93%E6%BB%A1%E6%80%8E%E4%B9%88%E5%8A%9E%EF%BC%9F"><span class="toc-number">6.0.2.1.</span> <span class="toc-text">2.1 CPU打满怎么办？</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-2-%E5%AE%BF%E4%B8%BB%E6%9C%BA%E5%AE%95%E6%9C%BA%E6%80%8E%E4%B9%88%E5%8A%9E%EF%BC%9F"><span class="toc-number">6.0.2.2.</span> <span class="toc-text">2.2 宿主机宕机怎么办？</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-3-Reindex%E8%A6%81%E5%A4%9A%E4%B9%85%EF%BC%9F"><span class="toc-number">6.0.2.3.</span> <span class="toc-text">2.3 Reindex要多久？</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3%E3%80%81%E6%9F%A5%E8%AF%A2%E8%A7%84%E8%8C%83%E7%9B%B8%E5%85%B3"><span class="toc-number">6.0.3.</span> <span class="toc-text">3、查询规范相关</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#3-1-wildcard-query%E9%80%9A%E9%85%8D%E7%AC%A6%E6%9F%A5%E8%AF%A2%E4%B8%8D%E8%A6%81%E4%BB%A5%E2%80%9C-%E2%80%9D%E5%BC%80%E5%A4%B4"><span class="toc-number">6.0.3.1.</span> <span class="toc-text">3.1 wildcard query通配符查询不要以“*”开头</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3-2-%E6%A8%A1%E7%B3%8A%E6%9F%A5%E8%AF%A2%E5%B0%BD%E9%87%8F%E4%BD%BF%E7%94%A8%E5%88%86%E8%AF%8D%E6%9F%A5%E8%AF%A2-match%E6%9B%BF%E4%BB%A3"><span class="toc-number">6.0.3.2.</span> <span class="toc-text">3.2 模糊查询尽量使用分词查询-match替代</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3-3-ES%E8%81%9A%E5%90%88%E6%9F%A5%E8%AF%A2%E4%B8%8D%E8%A6%81%E8%B6%85%E8%BF%87%E4%B8%89%E5%B1%82"><span class="toc-number">6.0.3.3.</span> <span class="toc-text">3.3 ES聚合查询不要超过三层</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3-4-Terms%E5%85%A5%E5%8F%82%E4%B8%8D%E8%A6%81%E8%B6%85%E8%BF%87100"><span class="toc-number">6.0.3.4.</span> <span class="toc-text">3.4 Terms入参不要超过100</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3-5-%E5%B0%BD%E9%87%8F%E4%B8%8D%E8%A6%81%E7%88%B6%E5%AD%90%E6%9F%A5%E8%AF%A2"><span class="toc-number">6.0.3.5.</span> <span class="toc-text">3.5 尽量不要父子查询</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3-6-%E8%8C%83%E5%9B%B4%E6%9F%A5%E8%AF%A2"><span class="toc-number">6.0.3.6.</span> <span class="toc-text">3.6  范围查询</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3-7-FilterQuery-%E4%BC%98%E5%8C%96"><span class="toc-number">6.0.3.7.</span> <span class="toc-text">3.7 FilterQuery 优化</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3-8-%E4%B8%8D%E8%A6%81%E4%BD%BF%E7%94%A8match-All-%E6%9F%A5%E8%AF%A2"><span class="toc-number">6.0.3.8.</span> <span class="toc-text">3.8 不要使用match All 查询</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3-9-%E9%81%BF%E5%85%8D%E4%BD%BF%E7%94%A8%E6%9F%A5%E8%AF%A2%E6%97%B6%E7%9A%84script%E8%AE%A1%E7%AE%97"><span class="toc-number">6.0.3.9.</span> <span class="toc-text">3.9 避免使用查询时的script计算</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3-10-%E6%B7%B1%E5%BA%A6%E7%BF%BB%E9%A1%B5"><span class="toc-number">6.0.3.10.</span> <span class="toc-text">3.10 深度翻页</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3-11-%E6%8E%A7%E5%88%B6%E8%BF%94%E5%9B%9E%E5%AD%97%E6%AE%B5%EF%BC%8C"><span class="toc-number">6.0.3.11.</span> <span class="toc-text">3.11 控制返回字段，</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3-12-%E5%88%AB%E5%90%8D%E6%9F%A5%E8%AF%A2%E8%A6%81%E5%AE%9A%E6%9C%9F%E6%B8%85%E7%90%86%E6%88%96%E8%80%85%E8%A7%A3%E7%BB%91%E5%8E%86%E5%8F%B2%E7%B4%A2%E5%BC%95"><span class="toc-number">6.0.3.12.</span> <span class="toc-text">3.12 别名查询要定期清理或者解绑历史索引</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3-13-%E6%9F%A5%E8%AF%A2%E4%B8%8D%E8%A6%81%E5%A4%AA%E5%A4%8D%E6%9D%82"><span class="toc-number">6.0.3.13.</span> <span class="toc-text">3.13 查询不要太复杂</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3-14-%E9%AB%98%E5%B3%B0%E6%9C%9F%E9%81%BF%E5%85%8D%E7%9A%84%E4%B8%80%E4%BA%9B%E6%93%8D%E4%BD%9C"><span class="toc-number">6.0.3.14.</span> <span class="toc-text">3.14 高峰期避免的一些操作</span></a></li></ol></li></ol></li></ol></li></ol></div></div></div><header class="post-bg" id="page-header" style="background-image: url(/img/jump.png)"><nav id="nav"><span id="blog_name"><a id="site-name" href="/">王鹏宇的博客</a></span><span id="menus"><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 主页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 归档</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><i class="fa-fw fas fa-list"></i><span> 娱乐</span><i class="fas fa-chevron-down expand"></i></a><ul class="menus_item_child"><li><a class="site-page" href="/music/"><i class="fa-fw fas fa-music"></i><span> 音乐</span></a></li><li><a class="site-page" href="/movies/"><i class="fa-fw fas fa-video"></i><span> 电影</span></a></li><li><a class="site-page" href="/photos/"><i class="fa-fw fas fa-camera-retro"></i><span> 相册</span></a></li><li><a class="site-page" href="/books/"><i class="fa-fw fas fa-camera-retro"></i><span> 书籍</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> 连接</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> 关于我</span></a></div></div><span class="close" id="toggle-menu"><a class="site-page"><i class="fas fa-bars fa-fw"></i></a></span></span></nav><div id="post-info"><div id="post-title"><div class="posttitle">ES常见基础问题总结</div></div><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" datetime="2023-02-12T10:43:15.000Z" title="发表于 2023-02-12 18:43:15">2023-02-12</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" datetime="2023-06-03T07:27:16.568Z" title="更新于 2023-06-03 15:27:16">2023-06-03</time></span></div><div class="meta-secondline"> <span class="post-meta-separator">|</span><span class="post-meta-pv-cv"><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">阅读量:</span><span id="busuanzi_value_page_pv"></span></span></div></div></div></header><main class="layout_post" id="content-inner"><article id="post"><div class="post-content" id="article-container"><h1 id="一、ES的特点"><a href="#一、ES的特点" class="headerlink" title="一、ES的特点"></a>一、ES的特点</h1><ul>
<li><p><strong>ES 是近实时搜索</strong>，其实近实时搜索是 Lucene 的功能，ES默认的延迟是1秒，主要原因是ES数据在写入之后会现在内存buffer中停留一段时间，然后再刷新至系统缓存和磁盘，数据在内存buffer中还不能被检索，所以叫近实时还不是完全实时。</p>
</li>
<li><p><strong>ES 的生态更加完善</strong>，ES生态包含ElasticSearch（存储和检索的核心），Logstash（数据处理管道，可以收集多个数据源的数据最终传输到ES，主要用来收集日志），Kibana（页面展示，可以理解为可视化的数据管理平台）。</p>
</li>
<li><p><strong>横向扩展方便</strong>，ES 能够实现平滑扩容，只要添加机器，就能够自动扩容，不需要使用 Zookeeper。</p>
</li>
<li><p><strong>简单，容易上手</strong>，ES 上手特别简单，无需大量配置即可上手，这也就是我们熟悉的 “约定大于配置”。</p>
</li>
</ul>
<h1 id="二、ES的适用场景"><a href="#二、ES的适用场景" class="headerlink" title="二、ES的适用场景"></a>二、ES的适用场景</h1><h4 id="关系型数据库的补充、传统数据库的替代"><a href="#关系型数据库的补充、传统数据库的替代" class="headerlink" title="关系型数据库的补充、传统数据库的替代"></a>关系型数据库的补充、传统数据库的替代</h4><p>ES 可以实现一些关系型数据库难以实现的功能，比如位置查询，滑动窗口查询等，ES 可以作为关系型数据库的补充，用来弥补关系型数据中的不足，也可能在某些情况下替代关系型数据库。</p>
<h4 id="站内搜索、垂直搜索"><a href="#站内搜索、垂直搜索" class="headerlink" title="站内搜索、垂直搜索"></a>站内搜索、垂直搜索</h4><p>电商网站的商品搜索可以说是站内搜索比如点评主站搜索，垂直搜索比如外卖频道的搜索，优选频道的搜索属于垂直搜索，目前都有使用ES。</p>
<h4 id="记录和日志分析"><a href="#记录和日志分析" class="headerlink" title="记录和日志分析"></a>记录和日志分析</h4><p>我们可以对海量数据进行近实时的处理，对复杂的日志进行分析，得到我们想要的结果，比如咱们公司的Logcenter，Raptor都使用ES来存储和搜索。</p>
<h4 id="全文检索"><a href="#全文检索" class="headerlink" title="全文检索"></a>全文检索</h4><p><strong>什么叫全文检索？</strong></p>
<blockquote>
<p>全文检索是针对Text字段，也就是字符串类型的字段，ES对字段中的所有词建立倒排索引，这样我们在检索的时候输入任何一个词，都能检索到对应的记录，举个例子：</p>
<p>skuName：”统一老坛酸菜牛肉面”，ES会对这个skuName先进行分词，标准分词结果是“统一”，“老坛”，“酸菜”，“牛肉面”，“统一老坛”，“酸菜牛肉面”，“老坛酸菜牛肉面”，“统一老坛酸菜牛肉面”，分词之后再建立倒排索引，这样我们在搜索的时候，输入“统一”或者“老坛”都能查询到结果，这就是全文检索的逻辑。</p>
<p>如果想针对skuName每个子集都能搜到，也可以按滑动窗口ngram_analyzer分词器进行分词，<strong>不过要考虑带来的额外存储成本</strong></p>
</blockquote>
<p>作为 Elasticsearch 的核心功能，全文搜索在 ES 应用场景中占据着重要的位置。</p>
<h1 id="三、ES和MySQL的选择"><a href="#三、ES和MySQL的选择" class="headerlink" title="三、ES和MySQL的选择"></a>三、ES和MySQL的选择</h1><table>
<thead>
<tr>
<th>术语</th>
<th align="left">描述</th>
<th align="left">用法</th>
<th align="left">数据库对比概念</th>
</tr>
</thead>
<tbody><tr>
<td>字段(Field)</td>
<td align="left">用于表述每一个列的名字，字段是文档的组成单元，包含字段名称、字段属性和字段内容</td>
<td align="left">例如商户名，城市名就分别是一个字段</td>
<td align="left">列</td>
</tr>
<tr>
<td>字段属性(Attributes)</td>
<td align="left">描述字段的属性，例如城市名的属性是一个字符串类型，不需要分词等</td>
<td align="left">用来描述字段的，包括是否建倒排、正排、分词、值的类型(数字类型、字符串类型等)</td>
<td align="left">类似字段的Varchar(16),int(20),是否index，primary_index等</td>
</tr>
<tr>
<td>文档(document)</td>
<td align="left">文档是可搜索的结构化数据单元，用于描述一整条记录，由多个字段组成</td>
<td align="left">例如上海天山西路的KFC商户我们可以作为一个文档</td>
<td align="left">记录行</td>
</tr>
<tr>
<td>索引(index)</td>
<td align="left">用于描述多个行记录的集合</td>
<td align="left">例如把所有的商户放在一个索引里</td>
<td align="left">表</td>
</tr>
<tr>
<td>正排</td>
<td align="left">文档到字段对应关系组成的链表，勾选可过滤后会构建正排链表。doc1-&gt;id,type,create_time…</td>
<td align="left">设置docvalues=true</td>
<td align="left">行记录</td>
</tr>
<tr>
<td>倒排</td>
<td align="left">词组到文档的对应关系组成的链表，勾选可搜索后会构建倒排链表。term1-&gt;doc1,doc2,doc3；term2-&gt;doc1,doc2</td>
<td align="left">设置index=true，如果为false，对应的字段域将不能进行检索(即执行各种Query后返回的结果为空，或者直接报错)</td>
<td align="left">类似B+树索引<br />Mysql不设置索引还是可以进行查询，但是ES不设置，查询结果为空</td>
</tr>
<tr>
<td>召回</td>
<td align="left">通过用户查询的关键词进行分词，将分词后的词组通过查找倒排链表快速定位到文档，这个过程称为召回。</td>
<td align="left"></td>
<td align="left">查询过程</td>
</tr>
<tr>
<td>召回量</td>
<td align="left">召回得到的文档数为召回量，即totalhits</td>
<td align="left"></td>
<td align="left">查询返回的结果数</td>
</tr>
<tr>
<td>分片(Shard)</td>
<td align="left">一个索引由多个分片组成，这些分片是索引里面的一部分，每一个分片都具备索引相同的数据结构</td>
<td align="left">一个索引分成N个shard，每一个Shard的内容就是这个完整索内容的1/N</td>
<td align="left">-</td>
</tr>
<tr>
<td>段(Segment)</td>
<td align="left">分片的组成单元，即多个段构成一个分片，段是检索的基本单元，所有的查询/更新都是基于段来查询的，</td>
<td align="left"></td>
<td align="left"></td>
</tr>
<tr>
<td>段合并</td>
<td align="left">Lucene的删除是标记删除，更新是先删后增，随着数据不断的更新，一个分片中会累积很多段(这些段里存在很多已经删掉的文档)，段太多会导致查询性能变慢，因此我们需要一个段合并的过程，将那些没有用的数据清除，减少段的个数</td>
<td align="left"></td>
<td align="left"></td>
</tr>
</tbody></table>
<p>Mysql的不足：</p>
<ol>
<li><strong>复杂条件搜索无法全部创建索引，索引的存储成本和公司规范</strong>：以 innoDB 为例，每加一个索引，就会创建一颗 B+ 树，如果是海量数据，将会增加很大的存储成本。公司规范要求每个表索引不能超过5个；</li>
<li><strong>全文检索和模糊搜索性能较差</strong>：如商品名模糊搜索，skuName like %橙汁% ，mysql无法走索引会导致全表扫描；</li>
<li><strong>Mysql多表Join性能较差</strong>。</li>
</ol>
<p>ES的特点：</p>
<ol>
<li><strong>轻松支持各种复杂的查询条件</strong>：它是分布式实时文件存储，会根据类型把字段编入索引(倒排索引)，利用高效的倒排索引，以及自定义打分、排序能力与丰富的分词插件等，能实现任意复杂查询条件下的全文检索需求；</li>
<li><strong>可扩展性强</strong>：天然支持分布式存储，通过极其简单的配置实现几百上千台服务器的分布式横向扩容，轻松处理 PB 级别的结构化或非结构化数据。包括进行数据异构和组建宽表，可以较方便解决多表join查询问题；</li>
<li><strong>高可用，容灾性能好</strong>：通过使用主备节点，以及故障的自动探测与恢复，有力地保障了高可用。</li>
</ol>
<p>BUT，按美团或者说至少优选物流侧ES选型风格来说，能不用ES就不用ES</p>
<h1 id="四、ES读写大致流程和最佳实践"><a href="#四、ES读写大致流程和最佳实践" class="headerlink" title="四、ES读写大致流程和最佳实践"></a>四、ES读写大致流程和最佳实践</h1><h3 id="写入流程"><a href="#写入流程" class="headerlink" title="写入流程"></a>写入流程</h3><p><img src="/blogImg/ES%E5%86%99%E5%85%A5%E6%B5%81%E7%A8%8B.png" alt="ES写入流程"></p>
<h3 id="最佳实践"><a href="#最佳实践" class="headerlink" title="最佳实践"></a>最佳实践</h3><p>集群配置</p>
<ol>
<li>高写入请使用SSD磁盘</li>
<li>分片均匀分配到各个节点，保证流量均衡分布（ES会自动均衡）</li>
</ol>
<p>索引配置</p>
<ol>
<li>无需分词、需要精确搜索的字段使用keyword，需要范围搜索的字段用满足需求较短的数字类型</li>
<li>refresh间隔越大写入越快，相应增加index buffer</li>
<li>无需搜索的字段index设置为false（慎重、非必须）</li>
<li>如果不需要聚合查询，doc_value设置为false</li>
</ol>
<p>写入过程</p>
<ol>
<li>使用bulk，减少IO开销</li>
<li>写入期间可以将副本设置为0，写完后增加副本</li>
</ol>
<h3 id="查询流程"><a href="#查询流程" class="headerlink" title="查询流程"></a>查询流程</h3><p><img src="/blogImg/ES%E6%9F%A5%E8%AF%A2%E6%B5%81%E7%A8%8B.png" alt="ES查询流程"></p>
<h3 id="最佳实践-1"><a href="#最佳实践-1" class="headerlink" title="最佳实践"></a>最佳实践</h3><p>集群配置</p>
<ol>
<li>data节点配置优于master节点</li>
<li>读多的集群内存选择16G以上，缓存可以加快查询</li>
<li>使用冷热隔离，冷数据放在配置低的集群</li>
</ol>
<p>索引配置</p>
<ol>
<li>增加副本可以提高查询吞吐，但是会影响写入</li>
<li>字段类型选择<ol>
<li>字符串类型，如果需要分词则选择text，会对每个词建立倒排索引，存储成本较高，所以无需分词得情况请使用keyword</li>
<li>数值类型，尽量选择贴合实际数值大小得类型，比如价格，使用float或者double,<strong>不需要范围查询尽量使用keyword，在5.x数字类型的Term查询性能相比2.x下降80%，CPU利用率也会飙升30%左右。</strong></li>
</ol>
</li>
<li>单个分片不超过50G，单个索引分片数不超过50</li>
<li>定期进行段文件合并，段文件越多，遍历次数越多</li>
</ol>
<h1 id="五、我们常用的es数据类型和注意事项"><a href="#五、我们常用的es数据类型和注意事项" class="headerlink" title="五、我们常用的es数据类型和注意事项"></a>五、我们常用的es数据类型和注意事项</h1><h4 id="数字类型"><a href="#数字类型" class="headerlink" title="数字类型"></a><strong>数字类型</strong></h4><p>数字类型用来存储各种数据信息，是检索中的最基础类型。</p>
<p><strong>WARNING</strong>：在5.x及以上的ES版本中使用term query进行查找数字类型数据，性能相比2.x版本急剧下降，且资源利用率超高，这是因为在5.x版本后，数字类型进行索引替换成了BKD树，这种数据结构导致进行精确查找非常慢，但是进行范围查询速度超级快，一般快于2.x版本5~10倍。因此对于需要范围查询的数据，可以定义为数字类型，否则尽量定义为keyword。<strong>如目前分拣明细中的履约日期，是数字类型，因为考虑到之前web也有多个履约日期的范围查询需求，因此查询es履约日期注意使用范围查询而不是term query</strong></p>
<p>在满足需求的情况下，尽可能选择范围小的数据类型。比如，某个字段的取值最大值不会超过100，那么选择byte类型，<strong>字段的长度越短，索引和搜索的效率越高</strong>。</p>
<h4 id="keyword类型"><a href="#keyword类型" class="headerlink" title="keyword类型"></a><strong>keyword类型</strong></h4><p>keyword类型适用于索引结构化的字段，比如email地址、主机名、状态码和标签。如果字段需要进行过滤(比如查找商品温层)、排序、聚合则使用。</p>
<p><strong>constant_keyword类型:</strong> 关键词的value永远都是相同的值</p>
<h4 id="布尔类型-boolean"><a href="#布尔类型-boolean" class="headerlink" title="布尔类型(boolean)"></a><strong>布尔类型(boolean)</strong></h4><p>逻辑类型（布尔类型）可以接受true/false/“true”/“false”值</p>
<h4 id="日期类型-date"><a href="#日期类型-date" class="headerlink" title="日期类型(date)"></a><strong>日期类型(date)</strong></h4><p>日期类型表示格式可以是以下几种：</p>
<p>（1）日期格式的<strong>字符串</strong>，比如 “2018-01-13” 或 “2018-01-13 12:10:30”<br>（2）long类型的<strong>毫秒数</strong>( milliseconds-since-the-epoch，epoch就是指UNIX诞生的UTC时间1970年1月1日0时0分0秒)<br>（3）integer的<strong>秒数</strong>(seconds-since-the-epoch)</p>
<p>ElasticSearch 内部会将日期数据转换为UTC，并存储为milliseconds-since-the-epoch的long型整数。<strong>时间最好直接存时间戳，这个还可能涉及时区等问题</strong></p>
<h4 id="数组类型-array"><a href="#数组类型-array" class="headerlink" title="数组类型(array)"></a><strong>数组类型(array)</strong></h4><p>ELasticsearch没有专用的数组类型，默认情况下任何字段都可以包含一个或者多个值，但是一个数组中的值要是同一种类型。例如：</p>
<ol>
<li>字符数组: [ “one”, “two” ]</li>
<li>整型数组：[1,3]</li>
<li>嵌套数组：[1,[2,3]],等价于[1,2,3]</li>
<li>对象数组：[ { “name”: “Mary”, “age”: 12 }, { “name”: “John”, “age”: 10 }]</li>
</ol>
<p><strong>注意事项：</strong></p>
<ul>
<li><strong>动态添加数据时，数组的第一个值的类型决定整个数组的类型</strong></li>
<li><strong>混合数组类型是不支持的，比如：[1,”abc”]</strong></li>
<li><strong>数组可以包含null值，空数组[ ]会被当做missing field对待。</strong></li>
</ul>
<h4 id="嵌套类型-nested"><a href="#嵌套类型-nested" class="headerlink" title="嵌套类型(nested)"></a><strong>嵌套类型(nested)</strong></h4><p>nested嵌套类型是object中的一个特例，可以让array类型的Object独立索引和查询。 最好不用，更新麻烦，需要painless脚本，性能较差</p>
<h4 id="文本类型"><a href="#文本类型" class="headerlink" title="文本类型"></a><strong>文本类型</strong></h4><p><strong>text类型：</strong>当一个字段是要被全文搜索被分词的字段，比如商品名称，应该使用text类型。设置text类型以后，字段内容会被分词，在生成倒排索引以前，字符串会被分析器分成一个一个词项。<strong>text类型的字段不能用于排序</strong>，坚决不能用于聚合。</p>
<h1 id="六、ES使用注意实现"><a href="#六、ES使用注意实现" class="headerlink" title="六、ES使用注意实现"></a>六、ES使用注意实现</h1><h3 id="1-eagle平台使用"><a href="#1-eagle平台使用" class="headerlink" title="1 eagle平台使用"></a>1 eagle平台使用</h3><h4 id="1-1-高峰期扩容"><a href="#1-1-高峰期扩容" class="headerlink" title="1.1 高峰期扩容"></a>1.1 高峰期扩容</h4><p>①、ES节点扩容，需要做数据均衡，扩容节点才能承担流量，均衡期间会占用IO，所以扩容尽量在低峰期进行。</p>
<p>②、如果在高峰期时QPS过高需要扩容，尽量限流。或者联系ES值班操作。</p>
<h4 id="1-2-线上慎用“profile”功能"><a href="#1-2-线上慎用“profile”功能" class="headerlink" title="1.2 线上慎用“profile”功能"></a>1.2 线上慎用“profile”功能</h4><p>①、ES profile的功能会执行一遍查询语句，然后显示各个阶段的耗时情况，但是在线上出现慢查询或者CPU飙高时，这个时候再进行profile会导致雪上加霜。</p>
<p>②、建议将查询语句复制到线下查看profile结果。</p>
<h4 id="1-3-不要修改ES字段的“index”属性"><a href="#1-3-不要修改ES字段的“index”属性" class="headerlink" title="1.3 不要修改ES字段的“index”属性"></a>1.3 不要修改ES字段的“index”属性</h4><p>①、ES默认会给所有字段建索引，也就是字段的“index”属性默认都是true，表示字段可以被精确匹配，如果改为false，字段将不能被检索。</p>
<p>②、ES的索引文件放在磁盘上，并且进行了压缩，不用太担心索引开销问题而修改index属性。</p>
<p>③、这个操作不可逆，后续如果该字段需要被检索，需要新建索引。</p>
<p>尽量不要在线上es平台直接进行复杂查询和高频率的无参数直接查询等</p>
<p>①、eagle平台不像rds会对超时查询杀死返回，因此复杂查询和高频率无参数查询会导致es集群压力增加，尤其高峰期不要使用。</p>
<p>②、如果使用不熟悉专家模式的DSL json查询方式，尽量在线下写好再复制到线上执行。</p>
<h3 id="2、故障处理相关"><a href="#2、故障处理相关" class="headerlink" title="2、故障处理相关"></a>2、故障处理相关</h3><h4 id="2-1-CPU打满怎么办？"><a href="#2-1-CPU打满怎么办？" class="headerlink" title="2.1 CPU打满怎么办？"></a>2.1 CPU打满怎么办？</h4><p>①、80%的情况都是<strong>慢查询</strong>导致，另外**20%**是QPS过高导致的。</p>
<p>②、业务先确保索引已经进行了慢日志配置，默认是400ms就会落地满日志，然后登录ES平台，点击监控–&gt;查看慢日志。</p>
<p>②、如果存在慢日志，尝试从业务层对慢查询进行限流。</p>
<p>③、如果不存在慢日志，查看读写QPS是否飙高，尝试从业务侧进行限流，然后再扩容。</p>
<p>④、SRE 总结参考：<a target="_blank" rel="noopener" href="https://km.sankuai.com/page/1206803065">ES 节点CPU过高处理流程</a></p>
<h4 id="2-2-宿主机宕机怎么办？"><a href="#2-2-宿主机宕机怎么办？" class="headerlink" title="2.2 宿主机宕机怎么办？"></a>2.2 宿主机宕机怎么办？</h4><p>①、ES节点是分布在不同的宿主机，正常情况下单台宿主机宕机，影响不大，不必慌张，集群会自动摘除宕机的节点。</p>
<p>②、别着急下线机器，避免丢数据，可以<strong>等待</strong>宿主机恢复，如果恢复不了，进行<strong>扩容。</strong></p>
<h4 id="2-3-Reindex要多久？"><a href="#2-3-Reindex要多久？" class="headerlink" title="2.3 Reindex要多久？"></a>2.3 Reindex要多久？</h4><p>①、Reindex本质上是先从老索引中<strong>scroll</strong>查询，然后再批量<strong>bulk</strong>写入到新索引，默认单词bulk写入的size是<strong>1000</strong>，scroll查询和bulk会占用IO和CPU资源，在索引较大的情况，请<strong>低峰期</strong>操作。</p>
<p>②、Reindex的速度和文档数量以及文档大小有关，给个大概的时间，<strong>1000</strong>万条记录，<strong>reindex</strong>需要20分钟，bulk写入的QPS在8左右，也就是<strong>每秒大概写入8000</strong>条数据。</p>
<p>③、按照上面的耗时统计，如果有频繁reindex需求，<strong>索引一定不能太大</strong>，否则reindex会耗时很久。</p>
<h3 id="3、查询规范相关"><a href="#3、查询规范相关" class="headerlink" title="3、查询规范相关"></a>3、查询规范相关</h3><h4 id="3-1-wildcard-query通配符查询不要以“-”开头"><a href="#3-1-wildcard-query通配符查询不要以“-”开头" class="headerlink" title="3.1 wildcard query通配符查询不要以“*”开头"></a>3.1 <strong>wildcard query通配符查询不要以“*”开头</strong></h4><ul>
<li>通配符开头的查询语句类似“*****橙汁”，针对这种通配符查询，ES底层需要构建DFA，如果字符串很长，构建DFA成本会巨大，从而导致CPU资源耗尽。</li>
<li>详情参考-<a target="_blank" rel="noopener" href="https://elasticsearch.cn/article/171">https://elasticsearch.cn/article/171</a></li>
</ul>
<h4 id="3-2-模糊查询尽量使用分词查询-match替代"><a href="#3-2-模糊查询尽量使用分词查询-match替代" class="headerlink" title="3.2 模糊查询尽量使用分词查询-match替代"></a>3.2 模糊查询尽量使用分词查询-match替代</h4><ul>
<li>模糊查询有<strong>wildcard query</strong>，<strong>fuzzy query</strong>，<strong>regrex</strong>这几种，和wildcard query一样，fuzzy query和regrex查询需要渐渐DFA（有穷自动机）这几类查询性能较差，一定使用注意相关词不要超过32个字符，严禁使用前后通配符<em>橙汁</em>。</li>
<li>观察查询对象，能否使用<strong>分词器</strong>处理进行term query查询，用空间换性能，当然也要考虑分词器增加的存储问题</li>
<li>如无特殊要求，尽量使用<strong>match</strong>或者<strong>match_query</strong>替代，大部分情况match query都能满足全文检索。</li>
</ul>
<h4 id="3-3-ES聚合查询不要超过三层"><a href="#3-3-ES聚合查询不要超过三层" class="headerlink" title="3.3 ES聚合查询不要超过三层"></a>3.3 ES聚合查询不要超过三层</h4><ul>
<li>聚合查询本质是在现有的结果再进行一次计算，如果是三层聚合相当于进行了三次计算，在数据量大的情况下，会严重占用CPU资源，需要控制聚合的数量。</li>
<li>核心链路聚合不要超过<strong>2</strong>层。</li>
<li>非核心链路聚合不要超过<strong>3</strong>层。</li>
</ul>
<h4 id="3-4-Terms入参不要超过100"><a href="#3-4-Terms入参不要超过100" class="headerlink" title="3.4 Terms入参不要超过100"></a>3.4 Terms入参不要超过100</h4><ul>
<li>Terms查询本质是多个term查询，但是如果terms的入参过多，需要将多个term的倒排链进行合并，该过程耗时较长，建议在索引数据量较大的情况，terms入参不要过多。</li>
</ul>
<h4 id="3-5-尽量不要父子查询"><a href="#3-5-尽量不要父子查询" class="headerlink" title="3.5 尽量不要父子查询"></a>3.5 尽量不要父子查询</h4><ul>
<li>避免使用嵌套类型，nested或者object，使用嵌套类型性能<strong>会慢10几倍</strong>，尽量把逻辑处理放在客户端代码。</li>
<li>避免使用父子关系，parent-child，使用父子类型性能会慢百倍以上。</li>
</ul>
<h4 id="3-6-范围查询"><a href="#3-6-范围查询" class="headerlink" title="3.6  范围查询"></a>3.6  范围查询</h4><ul>
<li>范围查询推荐使用<strong>整值型或者范围</strong>类型字段，<strong>number类型底层BKD数据结构更适合range查询，性能更佳。</strong></li>
</ul>
<p><strong>整值型字段</strong>包括：double，long，integer，short，byte。</p>
<p><strong>范围型字段</strong>包括：float_range，long_range，date_range，double_range</p>
<ul>
<li>Range查询扫描行数不要超过<strong>100000行</strong></li>
</ul>
<h4 id="3-7-FilterQuery-优化"><a href="#3-7-FilterQuery-优化" class="headerlink" title="3.7 FilterQuery 优化"></a>3.7 FilterQuery 优化</h4><ul>
<li>尽量使用query-bool-filter， filter的缓存机制会使的检索更快，尽量不使用must，must不会使用缓存且会计算分值</li>
</ul>
<h4 id="3-8-不要使用match-All-查询"><a href="#3-8-不要使用match-All-查询" class="headerlink" title="3.8 不要使用match All 查询"></a>3.8 <strong>不要使用match All 查询</strong></h4><ul>
<li><strong>尤其线上eagle平台，不要高频点击</strong></li>
</ul>
<h4 id="3-9-避免使用查询时的script计算"><a href="#3-9-避免使用查询时的script计算" class="headerlink" title="3.9 避免使用查询时的script计算"></a>3.9 避免使用查询时的script计算</h4><p>ES本身是基于倒排等数据结构实现的查询，因此在做类似Term、Match等可以利用底层数据结构的场景进行查询时，性能是很好的。</p>
<p>脚本和term等查询不一样，无法利用现有的各种数据结构，可以简单理解成循环</p>
<p>因此脚本的性能取决于两个地方：脚本的复杂度和满足条件的文档数。</p>
<h4 id="3-10-深度翻页"><a href="#3-10-深度翻页" class="headerlink" title="3.10 深度翻页"></a>3.10 <strong>深度翻页</strong></h4><ul>
<li>需要控制返回结果集，注意深度翻页问题，建议size不要超过1000，<strong>最大值不超过10000</strong>，这是引发full gc常见的原因。</li>
<li>如果需要遍历数据，请使用Scroll查询，如果对翻页有实时查询需求，可以使用SearchAfter，或者查看文档<a target="_blank" rel="noopener" href="https://km.sankuai.com/page/1291567971">全方位深度解读 Elasticsearch 分页查询</a>。</li>
</ul>
<h4 id="3-11-控制返回字段，"><a href="#3-11-控制返回字段，" class="headerlink" title="3.11 控制返回字段，"></a>3.11 控制返回字段，</h4><p>_source过滤,只返回业务相关的字段，减少IO开销</p>
<h4 id="3-12-别名查询要定期清理或者解绑历史索引"><a href="#3-12-别名查询要定期清理或者解绑历史索引" class="headerlink" title="3.12 别名查询要定期清理或者解绑历史索引"></a>3.12 别名查询要定期清理或者解绑历史索引</h4><p>别名使用于定期按照模板创建的索引，比如档期数据每个月建一个索引，查询时使用同一个别名，比较灵活，别名查询会遍历所有关联的索引，如果关联的索引过多，会导致单次查询遍历非常多的分片，从而影响性能。</p>
<ul>
<li>要定期对不需要的历史索引进行解绑或者清理。</li>
<li>别名绑定的索引不宜超过20个。</li>
</ul>
<h4 id="3-13-查询不要太复杂"><a href="#3-13-查询不要太复杂" class="headerlink" title="3.13 查询不要太复杂"></a>3.13 <strong>查询不要太复杂</strong></h4><ul>
<li>Term/Terms查询的入参个数<strong>不要超过100个</strong></li>
<li>子查询个数<strong>不要超过1000个</strong>，查询越复杂，性能越差，很容易导致集群崩掉。</li>
</ul>
<h4 id="3-14-高峰期避免的一些操作"><a href="#3-14-高峰期避免的一些操作" class="headerlink" title="3.14 高峰期避免的一些操作"></a>3.14 高峰期避免的一些操作</h4><ul>
<li>避免在高峰期进行段文件合并，段文件合并会消耗大量IO，影响查询和读写。</li>
<li>避免在高峰期做运维操作(包括扩容操作)</li>
</ul>
</div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/ES/">ES</a></div><div class="post_share"><div class="social-share" data-image="/img/jump.png" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/social-share.js/dist/css/share.min.css"><script src="https://cdn.jsdelivr.net/npm/social-share.js/dist/js/social-share.min.js" defer></script></div></div><div class="post-reward"><div class="reward-button"><i class="fas fa-qrcode"></i> 打赏<div class="reward-main"><ul class="reward-all"><li class="reward-item"><a href="/img/Wechatpay.jpeg" target="_blank"><img class="post-qr-code-img" src="/img/Wechatpay.jpeg" alt="微信"/></a><div class="post-qr-code-desc">微信</div></li><li class="reward-item"><a href="/img/alipay.jpeg" target="_blank"><img class="post-qr-code-img" src="/img/alipay.jpeg" alt="支付宝"/></a><div class="post-qr-code-desc">支付宝</div></li></ul></div></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/2023/03/03/%E5%88%86%E5%B8%83%E5%BC%8F%E7%B3%BB%E7%BB%9F%E2%80%94%E5%85%A8%E5%B1%80%E5%94%AF%E4%B8%80id%E5%AE%9E%E7%8E%B0%E6%96%B9%E6%A1%88/"><img class="prev-cover" src="/blogImg/64%E4%BD%8D%E9%9B%AA%E8%8A%B1%E7%AE%97%E6%B3%95.png" onerror="onerror=null;src='/img/404.jpg'"><div class="pagination-info"><div class="label">上一篇</div><div class="prev_info">分布式系统—全局唯一id实现方案</div></div></a></div><div class="next-post pull-right"><a href="/2023/02/01/%E5%88%86%E5%B8%83%E5%BC%8F%E7%B3%BB%E7%BB%9F%E2%80%94%E5%88%86%E5%B8%83%E5%BC%8F%E4%BA%8B%E5%8A%A1%E7%90%86%E8%AE%BA%E5%9F%BA%E7%A1%80/"><img class="next-cover" src="/img/jump.png" onerror="onerror=null;src='/img/404.jpg'"><div class="pagination-info"><div class="label">下一篇</div><div class="next_info">分布式事务相关理论基础</div></div></a></div></nav><div class="relatedPosts"><div class="headline"><i class="fas fa-thumbs-up fa-fw"></i><span> 相关推荐</span></div><div class="relatedPosts-list"><div><a href="/2023/05/30/Elasticsearch原理详解/" title="Elasticsearch原理详解"><img class="cover" src="/blogImg/ES%E9%9B%86%E7%BE%A4.png"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2023-05-30</div><div class="title">Elasticsearch原理详解</div></div></a></div></div></div><hr/><div id="post-comment"><div class="comment-head"><div class="comment-headline"><i class="fas fa-comments fa-fw"></i><span> 评论</span></div></div><div class="comment-wrap"><div><div id="utterances-wrap"></div></div></div></div></article></main><footer id="footer" data-type="color"><div id="footer-wrap"><div class="copyright">&copy;2020 - 2023 By Wangpengyu</div><div class="framework-info"><span>框架 </span><a target="_blank" rel="noopener" href="https://hexo.io">Hexo</a><span class="footer-separator">|</span><span>主题 </span><a target="_blank" rel="noopener" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly</a></div></div></footer></div><section id="rightside"><div id="rightside-config-hide"><button id="darkmode" type="button" title="浅色和深色模式转换"><i class="fas fa-adjust"></i></button></div><div id="rightside-config-show"><button id="rightside_config" type="button" title="设置"><i class="fas fa-cog"></i></button><a id="to_comment" href="#post-comment" title="直达评论"><i class="fas fa-comments"></i></a><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="fas fa-list-ul"></i></button><button id="go-up" type="button" title="回到顶部"><i class="fas fa-arrow-up"></i></button></div></section><div><script src="https://cdn.jsdelivr.net/npm/jquery@latest/dist/jquery.min.js"></script><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.js"></script><div class="js-pjax"><script>function loadUtterances () {
  let ele = document.createElement('script')
  ele.setAttribute('id', 'utterances_comment')
  ele.setAttribute('src', 'https://utteranc.es/client.js')
  ele.setAttribute('repo', 'silence314/commit-utterances')
  ele.setAttribute('issue-term', 'pathname')
  let nowTheme = document.documentElement.getAttribute('data-theme') === 'dark' ? 'photon-dark' : 'github-light'
  ele.setAttribute('theme', nowTheme)
  ele.setAttribute('crossorigin', 'anonymous')
  ele.setAttribute('async', 'true')
  document.getElementById('utterances-wrap').insertAdjacentElement('afterbegin',ele)
}

function utterancesTheme () {
  if (document.querySelector('.utterances-frame')) {
    const theme = document.documentElement.getAttribute('data-theme') === 'dark' ? 'photon-dark' : 'github-light'
    const message = {
      type: 'set-theme',
      theme: theme
    };
    const iframe = document.querySelector('.utterances-frame');
    iframe.contentWindow.postMessage(message, 'https://utteranc.es');
  }
}

if ('Utterances' === 'Utterances' || !true) {
  if (true) btf.loadComment(document.getElementById('utterances-wrap'), loadUtterances)
  else loadUtterances()
} else {
  function loadOtherComment () {
    loadUtterances()
  }
}</script><script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script></div><script id="canvas_nest" defer="defer" color="0,0,255" opacity="0.7" zIndex="-1" count="99" mobile="false" src="/js/third-party/canvas-nest.js"></script><script src="/js/third-party/activate-power-mode.js"></script><script>POWERMODE.colorful = true;
POWERMODE.shake = false;
document.body.addEventListener('input', POWERMODE);
</script><script src="/js/third-party/click_heart.js" async="async"></script><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/aplayer/dist/APlayer.min.css"><script src="https://cdn.jsdelivr.net/npm/aplayer/dist/APlayer.min.js"></script><script src="https://cdn.jsdelivr.net/gh/metowolf/MetingJS@1.2/dist/Meting.min.js"></script></div></body></html>